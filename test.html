<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>火柴人格鬥 完整版 + 噴血</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html,body{margin:0;height:100%;background:#111;color:#fff;font-family:sans-serif}
#app{width:360px;margin:auto;text-align:center}
canvas{background:#eee;border-radius:12px;margin-top:10px}
.key{border:1px solid #555;padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
<div id="app">
<h3>火柴人格鬥（完整版 + 噴血）</h3>
<canvas id="game" width="360" height="400"></canvas>
<div style="font-size:12px">
P1 <span class="key">A</span><span class="key">D</span><span class="key">W</span><span class="key">F</span><span class="key">G</span> |
P2 <span class="key">←</span><span class="key">→</span><span class="key">↑</span><span class="key">/</span><span class="key">.</span>
</div>
</div>

<script>
const c=game,ctx=c.getContext("2d");
const ground=300,grav=0.8;
let keys={},hitStop=0;
onkeydown=e=>keys[e.key]=1;
onkeyup=e=>keys[e.key]=0;

const AC=new (AudioContext||webkitAudioContext)();
function snd(f){let o=AC.createOscillator(),g=AC.createGain();
o.connect(g);g.connect(AC.destination);o.frequency.value=f;g.gain.value=0.12;
o.start();o.stop(AC.currentTime+0.08);}

function fighter(x,color){
return{
x,y:ground,vy:0,hp:100,energy:0,color,
walk:0,walkSpeed:0,
punch:false,punchT:0,hitFxDone:false,
dead:false,rot:0
}}

let p1=fighter(90,"#000"),p2=fighter(270,"#c00");
let fx=[];

function update(p,e,L,R,J,P,U,s=3){
if(p.dead)return;
// 走路擺動
if(L||R)p.walkSpeed=0.25;else p.walkSpeed*=0.8;
p.walk+=p.walkSpeed;

// 左右移動
if(L)p.x-=s;if(R)p.x+=s;
p.x=Math.max(20,Math.min(340,p.x));

// 跳躍
if(J&&p.y>=ground){p.vy=-12}
p.vy+=grav;p.y+=p.vy;
if(p.y>=ground){p.y=ground;p.vy=0}

// 普通攻擊
if(P&&!p.punch){
    p.punch=true;p.punchT=0;snd(200);
}
if(p.punch){
    p.punchT+=0.15;
    if(p.punchT>0.5 && Math.abs(p.x-e.x)<45 && !p.hitFxDone){
        // 被打中判定
        e.hp=Math.max(0,e.hp-10);
        e.x+=(e.x>p.x?1:-1)*8;
        hitStop=4;snd(120);
        p.energy=Math.min(100,p.energy+15);
        p.hitFxDone=true;

        // 噴血效果
        for(let i=0;i<6;i++) fx.push({
            x:e.x,
            y:e.y-40,
            vx:(Math.random()-0.5)*3,
            vy:-Math.random()*3,
            l:20,
            color:"red"
        });
    }
    if(p.punchT>=1){p.punch=false;p.hitFxDone=false;}
}

// 大招
if(U&&p.energy>=100){
    p.energy=0;
    let dir=e.x>p.x?1:-1;
    fx.push({wave:1,x:p.x,y:p.y-40,dir,l:30});
    snd(80);
}
}

function drawF(p){
ctx.save();ctx.translate(p.x,p.y-20);ctx.rotate(p.rot);
ctx.strokeStyle=p.color;ctx.lineWidth=4;
let leg=Math.sin(p.walk)*10;
let arm=p.punch?Math.sin(p.punchT*Math.PI)*15:0;

ctx.beginPath();ctx.arc(0,-30,10,0,7);ctx.stroke();
ctx.beginPath();ctx.moveTo(0,-20);ctx.lineTo(0,10);ctx.stroke();
ctx.beginPath();ctx.moveTo(0,-10);ctx.lineTo(-20+arm,-5);ctx.stroke();
ctx.beginPath();ctx.moveTo(0,-10);ctx.lineTo(20+arm,-5);ctx.stroke();
ctx.beginPath();ctx.moveTo(0,10);ctx.lineTo(-10,25+leg);ctx.stroke();
ctx.beginPath();ctx.moveTo(0,10);ctx.lineTo(10,25-leg);ctx.stroke();
ctx.restore();
}

function draw(){
ctx.clearRect(0,0,360,400);
ctx.fillStyle="red";
ctx.fillRect(10,10,p1.hp*1.2,8);
ctx.fillRect(360-10-p2.hp*1.2,10,p2.hp*1.2,8);
ctx.fillStyle="cyan";
ctx.fillRect(10,22,p1.energy*1.2,6);
ctx.fillRect(360-10-p2.energy*1.2,22,p2.energy*1.2,6);

drawF(p1);drawF(p2);

// 畫特效（噴血與大招）
fx.forEach(f=>{
    if(f.wave){
        ctx.fillStyle="cyan";
        ctx.beginPath();ctx.arc(f.x,f.y,8,0,7);ctx.fill();
        f.x+=f.dir*6;f.l--;
        let t=f.dir>0?p2:p1;
        if(Math.abs(f.x-t.x)<15){t.hp-=25;f.l=0;snd(100);}
    } else {
        ctx.fillStyle=f.color;
        ctx.fillRect(f.x,f.y,3,3);
        f.x+=f.vx; f.y+=f.vy; f.vy+=0.3; f.l--;
    }
});
fx=fx.filter(f=>f.l>0);
}

function loop(){
if(hitStop>0){hitStop--;draw();requestAnimationFrame(loop);return;}
update(p1,p2,keys.a,keys.d,keys.w,keys.f,keys.g);
update(p2,p1,keys.ArrowLeft,keys.ArrowRight,keys.ArrowUp,keys["/"],keys["."]);
draw();
requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
