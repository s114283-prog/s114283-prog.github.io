<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ç«æŸ´äººå°æ±º</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
html,body{margin:0;width:100%;height:100%}
body{display:flex;justify-content:center;align-items:center;background:#111;color:#fff;font-family:system-ui}
#app{width:360px;text-align:center}
canvas{background:#f5f5f5;border-radius:12px;margin:10px 0}
button,select,input{padding:6px 10px;border-radius:10px;border:none}
.menu,.end{display:flex;flex-direction:column;gap:10px;align-items:center}
#mobileControls{display:none;justify-content:space-between}
@media (orientation: landscape){#mobileControls{display:flex}}
.key{border:1px solid #555;padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
<div id="app">

<div id="menu" class="menu">
  <h2>ç«æŸ´äººå°æ±º</h2>
  <label><input type="radio" name="mode" value="cpu" checked> å–®äººï¼ˆæ‰“é›»è…¦ï¼‰</label>
  <label><input type="radio" name="mode" value="pvp"> é›™äººå°æˆ°</label>
  <div>
    AI é›£åº¦ï¼š
    <select id="difficulty">
      <option value="easy">ç°¡å–®</option>
      <option value="normal" selected>æ™®é€š</option>
      <option value="hard">å›°é›£</option>
    </select>
  </div>
  <div>ç©å®¶1 <input id="n1" value="ç©å®¶1"> <input type="color" id="c1" value="#000000"></div>
  <div>ç©å®¶2 <input id="n2" value="ç©å®¶2"> <input type="color" id="c2" value="#ff0000"></div>
  <button onclick="start()">é–‹å§‹éŠæˆ²</button>
</div>

<canvas id="game" width="360" height="400" style="display:none"></canvas>

<div id="mobileControls">
  <div>
    <button ontouchstart="m1L=1" ontouchend="m1L=0">â—€</button>
    <button ontouchstart="m1R=1" ontouchend="m1R=0">â–¶</button>
    <button ontouchstart="m1J=1" ontouchend="m1J=0">è·³</button>
    <button ontouchstart="m1P=1" ontouchend="m1P=0">ğŸ‘Š</button>
  </div>
  <div>
    <button ontouchstart="m2L=1" ontouchend="m2L=0">â—€</button>
    <button ontouchstart="m2R=1" ontouchend="m2R=0">â–¶</button>
    <button ontouchstart="m2J=1" ontouchend="m2J=0">è·³</button>
    <button ontouchstart="m2P=1" ontouchend="m2P=0">ğŸ‘Š</button>
  </div>
</div>

<div style="font-size:12px">
ğŸ’» P1 <span class="key">A</span><span class="key">D</span><span class="key">W</span><span class="key">F</span><span class="key">G</span>
ï½œ P2 <span class="key">â†</span><span class="key">â†’</span><span class="key">â†‘</span><span class="key">/</span><span class="key">.</span>
</div>

<div id="end" class="end" style="display:none">
  <h2 id="win"></h2>
  <button onclick="start()">å†ä¾†ä¸€å ´</button>
  <button onclick="back()">å›è¨­å®š</button>
</div>

</div>

<script>
const c=document.getElementById("game"),ctx=c.getContext("2d");
const ground=300,grav=0.8;
let k={},over=false,gameMode="cpu",aiLevel="normal";
let m1L=0,m1R=0,m1J=0,m1P=0,m2L=0,m2R=0,m2J=0,m2P=0;
window.onkeydown=e=>k[e.key]=1;
window.onkeyup=e=>k[e.key]=0;

const AudioCtx=new(window.AudioContext||webkitAudioContext)();
function sound(f){const o=AudioCtx.createOscillator(),g=AudioCtx.createGain();o.connect(g);g.connect(AudioCtx.destination);o.frequency.value=f;g.gain.value=0.15;o.start();o.stop(AudioCtx.currentTime+0.08);}

function fighter(x,name,color){
  return {x:x,y:ground,vy:0,hp:100,energy:0,name,color,punch:false,ult:false,onGround:true,dead:false,rot:0,walkPhase:0};
}

let p1,p2,effects=[];
const AI={easy:{speed:2,attack:0.02,ult:0.002},normal:{speed:3,attack:0.05,ult:0.01},hard:{speed:4,attack:0.1,ult:0.03}};

function cpuControl(cpu,pl){
  const a=AI[aiLevel];
  let L=0,R=0,J=0,P=0,U=0;
  const d=pl.x-cpu.x;
  if(Math.abs(d)>50) d>0?R=1:L=1;
  else if(Math.random()<a.attack) P=1;
  if(cpu.energy>=100 && Math.random()<a.ult) U=1;
  update(cpu,pl,L,R,J,P,U,a.speed);
}

function update(p,e,L,R,J,P,U,s=3){
  if(p.dead) return;
  if(L){p.x-=s;p.walkPhase+=0.3;} 
  if(R){p.x+=s;p.walkPhase+=0.3;}
  p.x=Math.max(15,Math.min(345,p.x));
  if(J&&p.onGround){p.vy=-12;p.onGround=false;}
  p.vy+=grav;p.y+=p.vy;
  if(p.y>=ground){p.y=ground;p.vy=0;p.onGround=true;}

  if(P&&!p.punch){
    p.punch=true; sound(200);
    if(Math.abs(p.x-e.x)<55){
      e.hp=Math.max(0,e.hp-10); sound(400);
      p.energy=Math.min(100,p.energy+20);
      // å™´è¡€ç²’å­
      for(let i=0;i<8;i++){
        effects.push({x:e.x,y:e.y-30,vx:(Math.random()-0.5)*4,vy:-Math.random()*3,l:20,color:"red",r:3});
      }
      // æ“Šé€€æ•ˆæœ
      e.x += (e.x>p.x?1:-1)*12; 
    }
    setTimeout(()=>p.punch=false,200);
  }

  if(U&&p.energy>=100&&!p.ult){
    p.energy=0; p.ult=true; sound(80);
    effects.push({type:"wave",x:p.x,y:p.y-40,dir:e.x>p.x?1:-1,l:40,own:p});
    setTimeout(()=>p.ult=false,400);
  }
}

function drawF(p){
  ctx.save(); ctx.translate(p.x,p.y-20); ctx.rotate(p.rot);
  ctx.strokeStyle=p.color; ctx.lineWidth=4;
  let leg=Math.sin(p.walkPhase)*5;
  ctx.beginPath(); ctx.arc(0,-30,10,0,7); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0,-20); ctx.lineTo(0,5); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0,-10); ctx.lineTo(-20,-5); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0,-10); ctx.lineTo(20,-5); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0,5); ctx.lineTo(-10,25+leg); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0,5); ctx.lineTo(10,25-leg); ctx.stroke();
  ctx.restore();
}

function draw(){
  ctx.clearRect(0,0,360,400);
  ctx.fillStyle="red"; ctx.fillRect(10,10,p1.hp*1.2,8); ctx.fillRect(360-10-p2.hp*1.2,10,p2.hp*1.2,8);
  ctx.fillStyle="cyan"; ctx.fillRect(10,22,p1.energy*1.2,6); ctx.fillRect(360-10-p2.energy*1.2,22,p2.energy*1.2,6);

  drawF(p1); drawF(p2);

  effects.forEach(e=>{
    if(e.type==="wave"){
      ctx.fillStyle="cyan"; ctx.beginPath(); ctx.arc(e.x,e.y,10,0,7); ctx.fill();
      e.x+=e.dir*6; e.l--;
      const t=e.own===p1?p2:p1;
      if(Math.abs(e.x-t.x)<15){t.hp=Math.max(0,t.hp-30); e.l=0; sound(400);}
    }else{
      ctx.fillStyle=e.color||"orange"; ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,7); ctx.fill();
      e.x+=e.vx; e.y+=e.vy; e.vy+=0.3; e.l--;
    }
  });
  effects=effects.filter(e=>e.l>0);
}

function loop(){
  if(over) return;
  if(gameMode==="cpu") cpuControl(p2,p1);
  update(p1,p2,k.a||m1L,k.d||m1R,k.w||m1J,k.f||m1P,k.g);
  if(gameMode==="pvp") update(p2,p1,k.ArrowLeft||m2L,k.ArrowRight||m2R,k.ArrowUp||m2J,k['/']||m2P,k['.']);

  if(p1.hp<=0) p1.dead=true;
  if(p2.hp<=0) p2.dead=true;
  if(p1.dead && p1.rot>-Math.PI/2) p1.rot-=0.05;
  if(p2.dead && p2.rot< Math.PI/2) p2.rot+=0.05;

  draw();

  if(Math.abs(p1.rot)>=Math.PI/2 || Math.abs(p2.rot)>=Math.PI/2){
    over=true; game.style.display="none"; end.style.display="flex";
    win.innerText=(p1.hp<=0?p2.name:p1.name)+" å‹åˆ©";
    return;
  }

  requestAnimationFrame(loop);
}

function start(){
  gameMode=document.querySelector('input[name="mode"]:checked').value;
  aiLevel=difficulty.value;
  p1=fighter(90,n1.value,c1.value);
  p2=fighter(270,n2.value,c2.value);
  menu.style.display="none";
  game.style.display="block";
  over=false; loop();
}

function back(){
  end.style.display="none";
  game.style.display="none";
  menu.style.display="flex";
}
</script>
</body>
</html>
