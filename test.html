<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>火柴人對決</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html,body{margin:0;width:100%;height:100%}
body{
  display:flex;justify-content:center;align-items:center;
  background:#111;color:#fff;font-family:system-ui
}
#app{width:360px;text-align:center}
canvas{background:#f5f5f5;border-radius:12px}
.menu,.end{display:flex;flex-direction:column;gap:10px}
button,select,input{padding:6px 10px;border-radius:8px;border:none}
.key{border:1px solid #666;padding:2px 6px;border-radius:6px;margin:0 2px}
</style>
</head>

<body>
<div id="app">

<div id="menu" class="menu">
<h2>火柴人對決</h2>

<label><input type="radio" name="mode" value="cpu" checked> 單人</label>
<label><input type="radio" name="mode" value="pvp"> 雙人</label>

<div>
AI 難度：
<select id="difficulty">
<option value="easy">簡單</option>
<option value="normal" selected>普通</option>
<option value="hard">困難</option>
</select>
</div>

<div>玩家1 <input id="n1" value="玩家1"> <input type="color" id="c1" value="#000000"></div>
<div>玩家2 <input id="n2" value="玩家2"> <input type="color" id="c2" value="#ff0000"></div>

<button onclick="start()">開始遊戲</button>
</div>

<canvas id="game" width="360" height="400" style="display:none"></canvas>

<div style="font-size:12px">
P1：
<span class="key">A</span>
<span class="key">D</span>
<span class="key">W</span>
<span class="key">F</span>
｜
P2：
<span class="key">←</span>
<span class="key">→</span>
<span class="key">↑</span>
<span class="key">/</span>
</div>

<div id="end" class="end" style="display:none">
<h2 id="win"></h2>
<button onclick="start()">再來一場</button>
<button onclick="back()">回選單</button>
</div>

</div>

<script>
const canvas=game,ctx=canvas.getContext("2d");
const ground=300,gravity=0.8;
let keys={},gameMode="cpu",aiLevel="normal",over=false;

window.addEventListener("keydown",e=>keys[e.key]=true);
window.addEventListener("keyup",e=>keys[e.key]=false);

function beep(freq){
  const a=new AudioContext();
  const o=a.createOscillator(),g=a.createGain();
  o.frequency.value=freq;g.gain.value=0.1;
  o.connect(g);g.connect(a.destination);
  o.start();o.stop(a.currentTime+0.08);
}

function Fighter(x,name,color){
  return{
    x,y:ground,vy:0,
    hp:100,
    name,color,
    face:1,
    punching:false,
    onGround:true,
    dead:false,
    rot:0,
    leg:0
  };
}

let p1,p2,blood=[];

const AI={
  easy:{speed:2,rate:0.02},
  normal:{speed:3,rate:0.05},
  hard:{speed:4,rate:0.1}
};

function cpuThink(cpu,pl){
  const a=AI[aiLevel];
  let L=false,R=false,P=false;

  const d=pl.x-cpu.x;
  cpu.face=d>0?1:-1;

  if(Math.abs(d)>45){
    d>0?R=true:L=true;
  }else{
    P=true; // 距離內一定打
  }

  update(cpu,pl,L,R,false,P,a.speed);
}

function update(p,e,L,R,J,P,speed=3){
  if(p.dead)return;

  if(L){p.x-=speed;p.face=-1;p.leg+=0.2;}
  if(R){p.x+=speed;p.face=1;p.leg+=0.2;}

  p.x=Math.max(20,Math.min(340,p.x));

  if(J && p.onGround){
    p.vy=-12;p.onGround=false;
  }

  p.vy+=gravity;p.y+=p.vy;
  if(p.y>=ground){p.y=ground;p.vy=0;p.onGround=true}

  if(P && !p.punching){
    p.punching=true;
    beep(200);

    if(Math.abs(p.x-e.x)<40){
      e.hp=Math.max(0,e.hp-10);
      for(let i=0;i<6;i++){
        blood.push({
          x:e.x,y:e.y-30,
          vx:(Math.random()-0.5)*3,
          vy:-Math.random()*3,
          life:20
        });
      }
    }

    setTimeout(()=>p.punching=false,200);
  }
}

function drawF(p){
  ctx.save();
  ctx.translate(p.x,p.y-20);
  ctx.rotate(p.rot);
  ctx.strokeStyle=p.color;
  ctx.lineWidth=4;

  ctx.beginPath();ctx.arc(0,-30,10,0,Math.PI*2);ctx.stroke();
  ctx.beginPath();ctx.moveTo(0,-20);ctx.lineTo(0,10);ctx.stroke();

  // 手
  ctx.beginPath();
  ctx.moveTo(0,-10);
  ctx.lineTo(20*p.face,-5);
  ctx.stroke();

  // 腳（動畫）
  ctx.beginPath();
  ctx.moveTo(0,10);
  ctx.lineTo(Math.sin(p.leg)*10,30);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(0,10);
  ctx.lineTo(-Math.sin(p.leg)*10,30);
  ctx.stroke();

  ctx.restore();
}

function draw(){
  ctx.clearRect(0,0,360,400);

  ctx.fillStyle="red";
  ctx.fillRect(10,10,p1.hp*1.2,8);
  ctx.fillRect(360-10-p2.hp*1.2,10,p2.hp*1.2,8);

  drawF(p1);drawF(p2);

  blood.forEach(b=>{
    ctx.fillStyle="darkred";
    ctx.fillRect(b.x,b.y,3,3);
    b.x+=b.vx;b.y+=b.vy;b.vy+=0.3;b.life--;
  });
  blood=blood.filter(b=>b.life>0);
}

function loop(){
  if(over)return;

  update(
    p1,p2,
    keys.a,keys.d,keys.w,keys.f
  );

  if(gameMode==="cpu"){
    cpuThink(p2,p1);
  }else{
    update(
      p2,p1,
      keys.ArrowLeft,keys.ArrowRight,keys.ArrowUp,keys["/"]
    );
  }

  if(p1.hp<=0||p2.hp<=0){
    over=true;
    win.textContent=(p1.hp<=0?p2.name:p1.name)+" 勝利";
    game.style.display="none";
    end.style.display="flex";
    return;
  }

  draw();
  requestAnimationFrame(loop);
}

function start(){
  gameMode=document.querySelector('[name=mode]:checked').value;
  aiLevel=difficulty.value;
  p1=Fighter(90,n1.value,c1.value);
  p2=Fighter(270,n2.value,c2.value);
  menu.style.display="none";
  end.style.display="none";
  game.style.display="block";
  over=false;
  loop();
}

function back(){
  end.style.display="none";
  game.style.display="none";
  menu.style.display="flex";
}
</script>
</body>
</html>

