<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>火柴人對決</title>
<link rel="icon" href="images.jpg">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html,body{margin:0;width:100%;height:100%}
body{
  display:flex;justify-content:center;align-items:center;
  background:#111;color:#fff;font-family:system-ui
}
#app{width:360px;text-align:center}
canvas{background:#f5f5f5;border-radius:12px;margin:10px 0}
button,select,input{padding:6px 10px;border-radius:10px;border:none}

.menu,.end{display:flex;flex-direction:column;gap:10px;align-items:center}

/* 鍵帽 icon */
.keys{font-size:12px;margin-top:6px}
.keycap{
  display:inline-block;
  padding:3px 6px;
  margin:0 2px;
  border-radius:6px;
  background:#222;
  border:1px solid #555;
  color:#fff;
  font-weight:bold;
}
</style>
</head>

<body>
<div id="app">

<div id="menu" class="menu">
<h2>火柴人對決</h2>

<label><input type="radio" name="mode" value="cpu" checked> 單人（打電腦）</label>
<label><input type="radio" name="mode" value="pvp"> 雙人對戰</label>

<div>
AI 難度
<select id="difficulty">
<option value="easy">簡單</option>
<option value="normal" selected>普通</option>
<option value="hard">困難</option>
</select>
</div>

<div>玩家1 <input id="n1" value="玩家1"> <input type="color" id="c1" value="#000000"></div>
<div>玩家2 <input id="n2" value="玩家2"> <input type="color" id="c2" value="#ff0000"></div>

<button onclick="start()">開始遊戲</button>
</div>

<canvas id="game" width="360" height="400" style="display:none"></canvas>

<!-- 鍵帽提示 -->
<div class="keys">
P1：
<span class="keycap">A</span>
<span class="keycap">D</span>
<span class="keycap">W</span>
<span class="keycap">F</span>
<span class="keycap">G</span>
｜
P2：
<span class="keycap">←</span>
<span class="keycap">→</span>
<span class="keycap">↑</span>
<span class="keycap">/</span>
<span class="keycap">.</span>
</div>

<div id="end" class="end" style="display:none">
<h2 id="win"></h2>
<button onclick="start()">再來一場</button>
<button onclick="back()">回設定</button>
</div>

</div>

<script>
const c=game,ctx=c.getContext("2d");
const ground=300,grav=0.8;
let k={},over=false,gameMode="cpu",aiLevel="normal";

onkeydown=e=>k[e.key]=1;
onkeyup=e=>k[e.key]=0;

/* 音效系統 */
const AC=new (window.AudioContext||webkitAudioContext)();
function beep(f,d=0.08){
  const o=AC.createOscillator(),g=AC.createGain();
  o.connect(g);g.connect(AC.destination);
  o.frequency.value=f;g.gain.value=0.15;
  o.start();o.stop(AC.currentTime+d);
}

function fighter(x,name,color){
return{
  x,y:ground,vy:0,
  hp:100,name,color,
  weapon:"fist",
  punch:false,
  onGround:true
}}

let p1,p2,effects=[];

const AI={
easy:{speed:2,attack:0.04},
normal:{speed:3,attack:0.08},
hard:{speed:4,attack:0.14}
};

function cpuControl(cpu,pl){
const a=AI[aiLevel];
let L=0,R=0,P=0;
const d=pl.x-cpu.x;
if(Math.abs(d)>50) d>0?R=1:L=1;
if(Math.random()<a.attack) P=1;
update(cpu,pl,L,R,0,P,a.speed);
}

function update(p,e,L,R,J,P,s=3){
if(L)p.x-=s;if(R)p.x+=s;
p.x=Math.max(20,Math.min(340,p.x));

if(J&&p.onGround){
  p.vy=-12;p.onGround=false;
  beep(400); // 跳躍音
}
p.vy+=grav;p.y+=p.vy;
if(p.y>=ground){p.y=ground;p.vy=0;p.onGround=true}

/* 換武器 */
if((p===p1&&k.g)||(p===p2&&k["."])){
  if(!p.switch){
    p.weapon=p.weapon==="fist"?"sword":"fist";
    beep(120); // 切換音
    p.switch=true;
  }
}else p.switch=false;

/* 攻擊 */
if(P&&!p.punch){
p.punch=true;
beep(p.weapon==="sword"?180:260);
let range=p.weapon==="sword"?70:45;
let dmg=p.weapon==="sword"?18:10;

if(Math.abs(p.x-e.x)<range){
  e.hp=Math.max(0,e.hp-dmg);
  beep(80); // 命中
  for(let i=0;i<6;i++)
    effects.push({
      x:e.x,y:e.y-30,
      vx:(Math.random()-0.5)*3,
      vy:-Math.random()*3,l:18
    });
}
setTimeout(()=>p.punch=false,200);
}
}

function drawF(p){
ctx.save();
ctx.translate(p.x,p.y-20);
ctx.strokeStyle=p.color;
ctx.lineWidth=4;

/* 頭 */
ctx.beginPath();ctx.arc(0,-30,10,0,7);ctx.stroke();
/* 身 */
ctx.beginPath();ctx.moveTo(0,-20);ctx.lineTo(0,10);ctx.stroke();
/* 手 */
ctx.beginPath();ctx.moveTo(0,-10);ctx.lineTo(-20,0);ctx.stroke();
ctx.beginPath();ctx.moveTo(0,-10);ctx.lineTo(20,0);ctx.stroke();
/* 劍 */
if(p.weapon==="sword"){
ctx.beginPath();ctx.moveTo(20,0);ctx.lineTo(45,-10);ctx.stroke();
}
/* 腳 */
ctx.beginPath();
ctx.moveTo(0,10);ctx.lineTo(-10,30);
ctx.moveTo(0,10);ctx.lineTo(10,30);
ctx.stroke();

ctx.restore();
}

function draw(){
ctx.clearRect(0,0,360,400);

/* 血量 */
ctx.fillStyle="red";
ctx.fillRect(10,10,p1.hp*1.2,8);
ctx.fillRect(360-10-p2.hp*1.2,10,p2.hp*1.2,8);

drawF(p1);drawF(p2);

/* 血粒子 */
effects.forEach(e=>{
ctx.fillStyle="red";
ctx.fillRect(e.x,e.y,3,3);
e.x+=e.vx;e.y+=e.vy;e.vy+=0.3;e.l--;
});
effects=effects.filter(e=>e.l>0);
}

function loop(){
if(over)return;
if(gameMode==="cpu") cpuControl(p2,p1);
update(p1,p2,k.a,k.d,k.w,k.f,3);
if(gameMode==="pvp")
update(p2,p1,k.ArrowLeft,k.ArrowRight,k.ArrowUp,k["/"],3);

draw();
if(p1.hp<=0||p2.hp<=0){
over=true;game.style.display="none";
end.style.display="flex";
win.innerText=(p1.hp<=0?p2.name:p1.name)+" 勝利";
}
requestAnimationFrame(loop);
}

function start(){
gameMode=document.querySelector('[name=mode]:checked').value;
aiLevel=difficulty.value;
p1=fighter(90,n1.value,c1.value);
p2=fighter(270,n2.value,c2.value);
menu.style.display="none";
game.style.display="block";
over=false;loop();
}
function back(){
end.style.display="none";
menu.style.display="flex";
}
</script>
</body>
</html>

