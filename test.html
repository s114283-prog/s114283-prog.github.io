<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>火柴人對決</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html,body{margin:0;width:100%;height:100%}
body{
  display:flex;justify-content:center;align-items:center;
  background:#111;color:#fff;font-family:system-ui
}
#app{width:360px;text-align:center}
canvas{background:#f5f5f5;border-radius:12px;margin:10px 0}
.menu,.end{display:flex;flex-direction:column;gap:10px}
.key{border:1px solid #555;padding:2px 6px;border-radius:6px}
</style>
</head>

<body>
<div id="app">

<div id="menu" class="menu">
  <h2>火柴人對決</h2>

  <label><input type="radio" name="mode" value="cpu" checked> 單人（打電腦）</label>
  <label><input type="radio" name="mode" value="pvp"> 雙人對戰</label>

  <div>
    AI 難度：
    <select id="difficulty">
      <option value="easy">簡單</option>
      <option value="normal" selected>普通</option>
      <option value="hard">困難</option>
    </select>
  </div>

  <div>玩家1 <input id="n1" value="玩家1"> <input type="color" id="c1" value="#000000"></div>
  <div>玩家2 <input id="n2" value="玩家2"> <input type="color" id="c2" value="#ff0000"></div>

  <button onclick="start()">開始遊戲</button>
</div>

<canvas id="game" width="360" height="400" style="display:none"></canvas>

<div style="font-size:12px">
P1 <span class="key">A</span><span class="key">D</span><span class="key">W</span><span class="key">F</span>
｜
P2 <span class="key">←</span><span class="key">→</span><span class="key">↑</span><span class="key">/</span>
</div>

<div id="end" class="end" style="display:none">
  <h2 id="win"></h2>
  <button onclick="start()">再來一場</button>
</div>

</div>

<script>
const canvas = game;
const ctx = canvas.getContext("2d");
const ground = 300;
const grav = 0.8;

let keys = {};
let gameMode = "cpu";
let aiLevel = "normal";
let over = false;

window.addEventListener("keydown",e=>keys[e.key]=true);
window.addEventListener("keyup",e=>keys[e.key]=false);

function fighter(x,name,color){
  return{
    x,y:ground,vy:0,
    hp:100,
    name,color,
    onGround:true,
    punch:false,
    rot:0,
    leg:0
  }
}

let p1,p2;
let effects=[];

const AI={
  easy:{speed:2,rate:0.02},
  normal:{speed:3,rate:0.05},
  hard:{speed:4,rate:0.1}
};

function cpuControl(cpu,pl){
  let L=0,R=0,P=0;
  const d = pl.x - cpu.x;
  if(Math.abs(d)>40) d>0?R=1:L=1;
  else if(Math.random()<AI[aiLevel].rate) P=1;
  update(cpu,pl,L,R,0,P,AI[aiLevel].speed);
}

function update(p,e,L,R,J,P,s=3){
  if(L)p.x-=s;
  if(R)p.x+=s;
  p.x=Math.max(15,Math.min(345,p.x));

  if(J && p.onGround){
    p.vy=-12;p.onGround=false;
  }

  p.vy+=grav;p.y+=p.vy;
  if(p.y>=ground){p.y=ground;p.vy=0;p.onGround=true}

  if(L||R)p.leg+=0.2;

  if(P && !p.punch){
    p.punch=true;
    if(Math.abs(p.x-e.x)<45){
      e.hp=Math.max(0,e.hp-10);
      effects.push({x:e.x,y:e.y-30,r:3,l:12});
    }
    setTimeout(()=>p.punch=false,200);
  }
}

function drawF(p){
  ctx.save();
  ctx.translate(p.x,p.y-20);
  ctx.rotate(p.rot);
  ctx.strokeStyle=p.color;
  ctx.lineWidth=4;

  ctx.beginPath();ctx.arc(0,-30,10,0,Math.PI*2);ctx.stroke();
  ctx.beginPath();ctx.moveTo(0,-20);ctx.lineTo(0,5);ctx.stroke();
  ctx.beginPath();ctx.moveTo(0,-10);ctx.lineTo(-20,-5);ctx.stroke();
  ctx.beginPath();ctx.moveTo(0,-10);ctx.lineTo(20,-5);ctx.stroke();

  const a=Math.sin(p.leg)*8;
  ctx.beginPath();ctx.moveTo(0,5);ctx.lineTo(-10+a,25);ctx.stroke();
  ctx.beginPath();ctx.moveTo(0,5);ctx.lineTo(10-a,25);ctx.stroke();

  ctx.restore();
}

function draw(){
  ctx.clearRect(0,0,360,400);

  ctx.fillStyle="red";
  ctx.fillRect(10,10,p1.hp*1.2,8);
  ctx.fillRect(360-10-p2.hp*1.2,10,p2.hp*1.2,8);

  drawF(p1);
  drawF(p2);

  effects.forEach(e=>{
    ctx.fillStyle="darkred";
    ctx.beginPath();ctx.arc(e.x,e.y,e.r,0,Math.PI*2);ctx.fill();
    e.y+=2;e.l--;
  });
  effects=effects.filter(e=>e.l>0);
}

function loop(){
  if(over)return;

  update(
    p1,p2,
    keys.a,keys.d,keys.w,keys.f
  );

  if(gameMode==="cpu"){
    cpuControl(p2,p1);
  }else{
    update(
      p2,p1,
      keys.ArrowLeft,keys.ArrowRight,keys.ArrowUp,keys["/"]
    );
  }

  draw();

  if(p1.hp<=0 || p2.hp<=0){
    over=true;
    game.style.display="none";
    end.style.display="flex";
    win.innerText=(p1.hp<=0?p2.name:p1.name)+" 勝利";
    return;
  }

  requestAnimationFrame(loop);
}

function start(){
  gameMode=document.querySelector('[name=mode]:checked').value;
  aiLevel=difficulty.value;
  p1=fighter(90,n1.value,c1.value);
  p2=fighter(270,n2.value,c2.value);
  over=false;
  menu.style.display="none";
  end.style.display="none";
  game.style.display="block";
  requestAnimationFrame(loop);
}
</script>
</body>
</html>

